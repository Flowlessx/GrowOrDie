
<meta name="viewport" content="width=device-width, initial-scale=1">
<link href="https://fonts.googleapis.com/css?family=Orbitron" rel="stylesheet">
<link rel="stylesheet" type="text/css" href="index.css">
</head>
<body id="fullscreen">


<video autoplay muted loop id="myVideo">
  <source src="GOD2.mp4" type="video/mp4">
  Your browser does not support HTML5 video.
</video>
<video autoplay muted loop id="myVideoMobile">
  <source src="GodMobile2.mp4" type="video/mp4">
  Your browser does not support HTML5 video.
</video>
<audio autoPlay>
  <source src="God.mp3" type="audio/mpeg">
</audio>
<div class="content">

    <button class="button button3 button-login" onclick="document.getElementById('id01').style.display='block'" style="width:auto;">LOGIN</button>
    <button class="button button3 button-register" onclick="document.getElementById('id02').style.display='block'" style="width:auto;">CREATE</button>

      <div id="id01" class="modal">

        <form class="modal-content animate" action="/action_page.php">
          <div class="imgcontainer">
            <span onclick="document.getElementById('id01').style.display='none'" class="close" title="Close Modal">&times;</span>
          </div>

          <div id="signDiv" class="container">
            <div >
            	Username: type="text"></input><br>
            	Password: < type="password"></input>
            	<button id="signDiv-signIn">Sign In</button>
            	<button id="signDiv-signUp">Sign Up</button>
            </div>
            <label for="uname"><b>Username</b></label>
            <input  id="signDiv-username"  type="text" placeholder="Enter Username" name="uname" required>

            <label for="psw"><b>Password</b></label>
            <input id="signDiv-password"type="password" placeholder="Enter Password" name="psw" required>

            <button type="submit">Login</button>
            <label>
              <input type="checkbox" checked="checked" name="remember"> Remember me
            </label>
          </div>

          <div class="container" style="background-color:#f1f1f1">
            <button type="button" onclick="document.getElementById('id01').style.display='none'" class="cancelbtn">Cancel</button>
            <span class="psw">Forgot <a href="#">password?</a></span>
          </div>
        </form>
      </div>

      <div id="id02" class="modal">

        <form class="modal-content animate" action="/action_page.php">
          <div class="imgcontainer">
            <span onclick="document.getElementById('id02').style.display='none'" class="close" title="Close Modal">&times;</span>
          </div>

          <div class="container">
            <label for="uname"><b>Username</b></label>
            <input type="text" placeholder="Enter Username" name="uname" required>

            <label for="psw"><b>Password</b></label>
            <input type="password" placeholder="Enter Password" name="psw" required>

            <label for="psw"><b>Password</b></label>
            <input type="password" placeholder="Enter Password" name="psw" required>

            <button type="submit">Join G.O.D.</button>
          </div>

          <div class="container" style="background-color:#f1f1f1">
            <button type="button" onclick="document.getElementById('id02').style.display='none'" class="cancelbtn">Cancel</button>
            <span class="psw">Forgot <a href="#">password?</a></span>
          </div>
        </form>
      </div>

</div>
<!--<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>-->
<div id="gameDiv" style="display:none;">
  <div id="game" style="position:absolute; width:500px; height:500px;">
    <canvas id="ctx" width="500" height="500" style=" position:absolute;  border:5px solid #000000;"></canvas>
    <canvas id="ctx-ui" width="500" height="500" style=" position:absolute;border: 5px solid #000000;"></canvas>
  </div>

  <div id="ui" style="position: absolute; width:500px; height:500px;">
      <button onclick="changeMap()" style="position: absolute; bottom: 0px; left:0px;">
        CHANGE MAP
      </button>
  </div>


<div id="belowGame"  style=" position:absolute; margin-top: 520px;width:">
  <div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
      <div>Hello!</div>
    </div>

    <form id="chat-form">
      <input id="chat-input" type="text" style="  width:500px"></input>
    </form>
</div>
</div>

<script src="/client/socket.js"></script>
<script>
//
var WIDTH = 500;
var HEIGHT = 500;
var socket = io();

//sign
var signDiv = document.getElementById('signDiv');
var signDivUsername = document.getElementById('signDiv-username');
var signDivSignIn = document.getElementById('signDiv-signIn');
var signDivSignUp = document.getElementById('signDiv-signUp');
var signDivPassword = document.getElementById('signDiv-password');

signDivSignIn.onclick = function(){
  socket.emit('signIn',{username:signDivUsername.value,password:signDivPassword.value});
}
signDivSignUp.onclick = function(){
  socket.emit('signUp',{username:signDivUsername.value,password:signDivPassword.value});
}
socket.on('signInResponse',function(data){
  if(data.success){
    signDiv.style.display = 'none';
    gameDiv.style.display = 'inline-block';
  } else
    alert("Sign in unsuccessul.");
});
socket.on('signUpResponse',function(data){
  if(data.success){
    alert("Sign up successul.");
  } else
    alert("Sign up unsuccessul.");
});

//chat
var chatText = document.getElementById('chat-text');
var chatInput = document.getElementById('chat-input');
var chatForm = document.getElementById('chat-form');

socket.on('addToChat',function(data){
  chatText.innerHTML += '<div>' + data + '</div>';
});
socket.on('evalAnswer',function(data){
  console.log(data);
});


chatForm.onsubmit = function(e){
  e.preventDefault();
  if(chatInput.value[0] === '/')
    socket.emit('evalServer',chatInput.value.slice(1));
  else
    socket.emit('sendMsgToServer',chatInput.value);
  chatInput.value = '';
}

//ui
var changeMap = function(){
  socket.emit('changeMap');
}

//game
var Img = {};
Img.player = new Image();
Img.player.src = '/client/img/player.png';
Img.bullet = new Image();
Img.bullet.src = '/client/img/bullet.png';

Img.map = {};
Img.map['field'] = new Image();
Img.map['field'].src = '/client/img/map.png';
Img.map['forest'] = new Image();
Img.map['forest'].src = '/client/img/map2.png';

var ctx = document.getElementById("ctx").getContext("2d");
var ctxUI = document.getElementById("ctx-ui").getContext("2d");
ctx.font = '30px Arial';

var Player = function(initPack){
  var self = {};
  self.id = initPack.id;
  self.number = initPack.number;
  self.x = initPack.x;
  self.y = initPack.y;
  self.hp = initPack.hp;
  self.hpMax = initPack.hpMax;
  self.score = initPack.score;
  self.map = initPack.map;

  self.draw = function(){
    if(Player.list[selfId].map !== self.map)
      return;
    var x = self.x - Player.list[selfId].x + WIDTH/2;
    var y = self.y - Player.list[selfId].y + HEIGHT/2;

    var hpWidth = 30 * self.hp / self.hpMax;
    ctx.fillStyle = 'red';
    ctx.fillRect(x - hpWidth/2,y - 40,hpWidth,4);

    var width = Img.player.width*2;
    var height = Img.player.height*2;


    ctx.drawImage(Img.player,
      0,0,Img.player.width,Img.player.height,
      x-width/2,y-height/2,width,height);

    //ctx.fillText(self.score,self.x,self.y-60);
  }

  Player.list[self.id] = self;


  return self;
}
Player.list = {};


var Bullet = function(initPack){
  var self = {};
  self.id = initPack.id;
  self.x = initPack.x;
  self.y = initPack.y;
  self.map = initPack.map;

  self.draw = function(){
    if(Player.list[selfId].map !== self.map)
      return;
    var width = Img.bullet.width/2;
    var height = Img.bullet.height/2;

    var x = self.x - Player.list[selfId].x + WIDTH/2;
    var y = self.y - Player.list[selfId].y + HEIGHT/2;

    ctx.drawImage(Img.bullet,
      0,0,Img.bullet.width,Img.bullet.height,
      x-width/2,y-height/2,width,height);
  }

  Bullet.list[self.id] = self;
  return self;
}
Bullet.list = {};

var selfId = null;

socket.on('init',function(data){
  if(data.selfId)
    selfId = data.selfId;
  //{ player : [{id:123,number:'1',x:0,y:0},{id:1,number:'2',x:0,y:0}], bullet: []}
  for(var i = 0 ; i < data.player.length; i++){
    new Player(data.player[i]);
  }
  for(var i = 0 ; i < data.bullet.length; i++){
    new Bullet(data.bullet[i]);
  }
});

socket.on('update',function(data){
  //{ player : [{id:123,x:0,y:0},{id:1,x:0,y:0}], bullet: []}
  for(var i = 0 ; i < data.player.length; i++){
    var pack = data.player[i];
    var p = Player.list[pack.id];
    if(p){
      if(pack.x !== undefined)
        p.x = pack.x;
      if(pack.y !== undefined)
        p.y = pack.y;
      if(pack.hp !== undefined)
        p.hp = pack.hp;
      if(pack.score !== undefined)
        p.score = pack.score;
      if(pack.map !== undefined)
        p.map = pack.map;
    }
  }
  for(var i = 0 ; i < data.bullet.length; i++){
    var pack = data.bullet[i];
    var b = Bullet.list[data.bullet[i].id];
    if(b){
      if(pack.x !== undefined)
        b.x = pack.x;
      if(pack.y !== undefined)
        b.y = pack.y;
    }
  }
});

socket.on('remove',function(data){
  //{player:[12323],bullet:[12323,123123]}
  for(var i = 0 ; i < data.player.length; i++){
    delete Player.list[data.player[i]];
  }
  for(var i = 0 ; i < data.bullet.length; i++){
    delete Bullet.list[data.bullet[i]];
  }
});

setInterval(function(){
  if(!selfId)
    return;
  ctx.clearRect(0,0,500,500);
  drawMap();
  drawScore();
  for(var i in Player.list)
    Player.list[i].draw();
  for(var i in Bullet.list)
    Bullet.list[i].draw();
},40);

var drawMap = function(){
  var player = Player.list[selfId];
  var x = WIDTH/2 - player.x;
  var y = HEIGHT/2 - player.y;
  ctx.drawImage(Img.map[player.map],x,y);
}

var drawScore = function(){
  if(lastScore === Player.list[selfId].score)
      return;
  lastScore = Player.list[selfId].score;

  ctxUI.fillStyle = 'white';
  ctxUI.clearRect(0,0,500,500);
  ctxUI.fillText(Player.list[selfId].score,0,30);
}
var lastScore = null;


document.onkeydown = function(event){
  if(event.keyCode === 68)	//d
    socket.emit('keyPress',{inputId:'right',state:true});
  else if(event.keyCode === 83)	//s
    socket.emit('keyPress',{inputId:'down',state:true});
  else if(event.keyCode === 65) //a
    socket.emit('keyPress',{inputId:'left',state:true});
  else if(event.keyCode === 87) // w
    socket.emit('keyPress',{inputId:'up',state:true});

}
document.onkeyup = function(event){
  if(event.keyCode === 68)	//d
    socket.emit('keyPress',{inputId:'right',state:false});
  else if(event.keyCode === 83)	//s
    socket.emit('keyPress',{inputId:'down',state:false});
  else if(event.keyCode === 65) //a
    socket.emit('keyPress',{inputId:'left',state:false});
  else if(event.keyCode === 87) // w
    socket.emit('keyPress',{inputId:'up',state:false});
}

document.onmousedown = function(event){
  socket.emit('keyPress',{inputId:'attack',state:true});
}
document.onmouseup = function(event){
  socket.emit('keyPress',{inputId:'attack',state:false});
}
document.onmousemove = function(event){
  var x = -250 + event.clientX - 8;
  var y = -250 + event.clientY - 8;
  var angle = Math.atan2(y,x) / Math.PI * 180;
  socket.emit('keyPress',{inputId:'mouseAngle',state:angle});
}

var video = document.getElementById("myVideo");
var btn = document.getElementById("myBtn");

function myFunction() {
  if (video.paused) {
    video.play();
    btn.innerHTML = "Pause";
  } else {
    video.pause();
    btn.innerHTML = "Play";
  }
}

// Get the modal
var modal = document.getElementById('id01');
var modal2 = document.getElementById('id02');
// When the user clicks anywhere outside of the modal, close it
window.onclick = function(event) {
    if (event.target == modal) {
        modal.style.display = "none";
    }
    if (event.target == modal2) {
        modal2.style.display = "none";
    }
}
var pfx = ["webkit", "moz", "ms", "o", ""];
function RunPrefixMethod(obj, method) {

	var p = 0, m, t;
	while (p < pfx.length && !obj[m]) {
		m = method;
		if (pfx[p] == "") {
			m = m.substr(0,1).toLowerCase() + m.substr(1);
		}
		m = pfx[p] + m;
		t = typeof obj[m];
		if (t != "undefined") {
			pfx = [pfx[p]];
			return (t == "function" ? obj[m]() : obj[m]);
		}
		p++;
	}

}
var e = document.getElementById("fullscreen");

e.onclick = function() {

	if (RunPrefixMethod(document, "FullScreen") || RunPrefixMethod(document, "IsFullScreen")) {
		RunPrefixMethod(document, "CancelFullScreen");
	}
	else {
		RunPrefixMethod(e, "RequestFullScreen");
	}

}
</script>

</body>
</html>
